<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Module: Capistrano::Configuration::Connections</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href="../../.././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Module</strong></td>
          <td class="class-name-in-header">Capistrano::Configuration::Connections</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../../../files/lib/capistrano/configuration/connections_rb.html">
                lib/capistrano/configuration/connections.rb
                </a>
        <br />
                <a href="../../../files/lib/capistrano/configuration/connections_rb.html">
                lib/capistrano/configuration/connections.rb
                </a>
        <br />
            </td>
        </tr>

        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">



   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M001475">connect!</a>&nbsp;&nbsp;
      <a href="#M001468">connect!</a>&nbsp;&nbsp;
      <a href="#M001476">connection_factory</a>&nbsp;&nbsp;
      <a href="#M001469">connection_factory</a>&nbsp;&nbsp;
      <a href="#M001477">establish_connections_to</a>&nbsp;&nbsp;
      <a href="#M001470">establish_connections_to</a>&nbsp;&nbsp;
      <a href="#M001472">execute_on_servers</a>&nbsp;&nbsp;
      <a href="#M001479">execute_on_servers</a>&nbsp;&nbsp;
      <a href="#M001473">failed!</a>&nbsp;&nbsp;
      <a href="#M001466">failed!</a>&nbsp;&nbsp;
      <a href="#M001467">has_failed?</a>&nbsp;&nbsp;
      <a href="#M001474">has_failed?</a>&nbsp;&nbsp;
      <a href="#M001478">teardown_connections_to</a>&nbsp;&nbsp;
      <a href="#M001471">teardown_connections_to</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">





    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">sessions</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
A hash of the <a href="../SSH.html">SSH</a> sessions that are currently
open and available. Because sessions are constructed lazily, this will only
contain connections to those servers that have been the targets of one or
more executed tasks.

</td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">sessions</td>
          <td class="context-item-value">&nbsp;[R]&nbsp;</td>
          <td class="context-item-desc">
A hash of the <a href="../SSH.html">SSH</a> sessions that are currently
open and available. Because sessions are constructed lazily, this will only
contain connections to those servers that have been the targets of one or
more executed tasks.

</td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Instance methods</h3>

      <div id="method-M001475" class="method-detail">
        <a name="M001475"></a>

        <div class="method-heading">
          <a href="#M001475" class="method-signature">
          <span class="method-name">connect!</span><span class="method-args">(options={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Used to force connections to be made to the current task&#8216;s servers.
<a href="Connections.html">Connections</a> are normally made lazily in <a
href="../../Capistrano.html">Capistrano</a>&#8212;you can use this to force
them open before performing some operation that might be time-sensitive.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001475-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001475-source">
<pre>
    <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 72</span>
72:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">connect!</span>(<span class="ruby-identifier">options</span>={})
73:         <span class="ruby-identifier">execute_on_servers</span>(<span class="ruby-identifier">options</span>) { }
74:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001468" class="method-detail">
        <a name="M001468"></a>

        <div class="method-heading">
          <a href="#M001468" class="method-signature">
          <span class="method-name">connect!</span><span class="method-args">(options={})</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Used to force connections to be made to the current task&#8216;s servers.
<a href="Connections.html">Connections</a> are normally made lazily in <a
href="../../Capistrano.html">Capistrano</a>&#8212;you can use this to force
them open before performing some operation that might be time-sensitive.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001468-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001468-source">
<pre>
    <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 72</span>
72:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">connect!</span>(<span class="ruby-identifier">options</span>={})
73:         <span class="ruby-identifier">execute_on_servers</span>(<span class="ruby-identifier">options</span>) { }
74:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001476" class="method-detail">
        <a name="M001476"></a>

        <div class="method-heading">
          <a href="#M001476" class="method-signature">
          <span class="method-name">connection_factory</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the object responsible for establishing new <a
href="../SSH.html">SSH</a> connections. The factory will respond to
connect_to, which can be used to establish connections to servers defined
via <a href="../ServerDefinition.html">ServerDefinition</a> objects.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001476-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001476-source">
<pre>
    <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 79</span>
79:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">connection_factory</span>
80:         <span class="ruby-ivar">@connection_factory</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword kw">begin</span>
81:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">:gateway</span>)
82:             <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;establishing connection to gateway `#{fetch(:gateway)}'&quot;</span>
83:             <span class="ruby-constant">GatewayConnectionFactory</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">:gateway</span>), <span class="ruby-keyword kw">self</span>)
84:           <span class="ruby-keyword kw">else</span>
85:             <span class="ruby-constant">DefaultConnectionFactory</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>)
86:           <span class="ruby-keyword kw">end</span>
87:         <span class="ruby-keyword kw">end</span>
88:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001469" class="method-detail">
        <a name="M001469"></a>

        <div class="method-heading">
          <a href="#M001469" class="method-signature">
          <span class="method-name">connection_factory</span><span class="method-args">()</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Returns the object responsible for establishing new <a
href="../SSH.html">SSH</a> connections. The factory will respond to
connect_to, which can be used to establish connections to servers defined
via <a href="../ServerDefinition.html">ServerDefinition</a> objects.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001469-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001469-source">
<pre>
    <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 79</span>
79:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">connection_factory</span>
80:         <span class="ruby-ivar">@connection_factory</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword kw">begin</span>
81:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">exists?</span>(<span class="ruby-identifier">:gateway</span>)
82:             <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">debug</span> <span class="ruby-node">&quot;establishing connection to gateway `#{fetch(:gateway)}'&quot;</span>
83:             <span class="ruby-constant">GatewayConnectionFactory</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">fetch</span>(<span class="ruby-identifier">:gateway</span>), <span class="ruby-keyword kw">self</span>)
84:           <span class="ruby-keyword kw">else</span>
85:             <span class="ruby-constant">DefaultConnectionFactory</span>.<span class="ruby-identifier">new</span>(<span class="ruby-keyword kw">self</span>)
86:           <span class="ruby-keyword kw">end</span>
87:         <span class="ruby-keyword kw">end</span>
88:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001477" class="method-detail">
        <a name="M001477"></a>

        <div class="method-heading">
          <a href="#M001477" class="method-signature">
          <span class="method-name">establish_connections_to</span><span class="method-args">(servers)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Ensures that there are active sessions for each server in the list.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001477-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001477-source">
<pre>
     <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 91</span>
 91:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">establish_connections_to</span>(<span class="ruby-identifier">servers</span>)
 92:         <span class="ruby-identifier">failed_servers</span> = []
 93: 
 94:         <span class="ruby-comment cmt"># force the connection factory to be instantiated synchronously,</span>
 95:         <span class="ruby-comment cmt"># otherwise we wind up with multiple gateway instances, because</span>
 96:         <span class="ruby-comment cmt"># each connection is done in parallel.</span>
 97:         <span class="ruby-identifier">connection_factory</span>
 98: 
 99:         <span class="ruby-identifier">threads</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">servers</span>).<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">server</span><span class="ruby-operator">|</span> <span class="ruby-identifier">establish_connection_to</span>(<span class="ruby-identifier">server</span>, <span class="ruby-identifier">failed_servers</span>) }
100:         <span class="ruby-identifier">threads</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">join</span> }
101: 
102:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">failed_servers</span>.<span class="ruby-identifier">any?</span>
103:           <span class="ruby-identifier">errors</span> = <span class="ruby-identifier">failed_servers</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{h[:server]} (#{h[:error].class}: #{h[:error].message})&quot;</span> }
104:           <span class="ruby-identifier">error</span> = <span class="ruby-constant">ConnectionError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;connection failed for: #{errors.join(', ')}&quot;</span>)
105:           <span class="ruby-identifier">error</span>.<span class="ruby-identifier">hosts</span> = <span class="ruby-identifier">failed_servers</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">:server</span>] }
106:           <span class="ruby-identifier">raise</span> <span class="ruby-identifier">error</span>
107:         <span class="ruby-keyword kw">end</span>
108:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001470" class="method-detail">
        <a name="M001470"></a>

        <div class="method-heading">
          <a href="#M001470" class="method-signature">
          <span class="method-name">establish_connections_to</span><span class="method-args">(servers)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Ensures that there are active sessions for each server in the list.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001470-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001470-source">
<pre>
     <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 91</span>
 91:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">establish_connections_to</span>(<span class="ruby-identifier">servers</span>)
 92:         <span class="ruby-identifier">failed_servers</span> = []
 93: 
 94:         <span class="ruby-comment cmt"># force the connection factory to be instantiated synchronously,</span>
 95:         <span class="ruby-comment cmt"># otherwise we wind up with multiple gateway instances, because</span>
 96:         <span class="ruby-comment cmt"># each connection is done in parallel.</span>
 97:         <span class="ruby-identifier">connection_factory</span>
 98: 
 99:         <span class="ruby-identifier">threads</span> = <span class="ruby-constant">Array</span>(<span class="ruby-identifier">servers</span>).<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">server</span><span class="ruby-operator">|</span> <span class="ruby-identifier">establish_connection_to</span>(<span class="ruby-identifier">server</span>, <span class="ruby-identifier">failed_servers</span>) }
100:         <span class="ruby-identifier">threads</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">t</span><span class="ruby-operator">|</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">join</span> }
101: 
102:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">failed_servers</span>.<span class="ruby-identifier">any?</span>
103:           <span class="ruby-identifier">errors</span> = <span class="ruby-identifier">failed_servers</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-node">&quot;#{h[:server]} (#{h[:error].class}: #{h[:error].message})&quot;</span> }
104:           <span class="ruby-identifier">error</span> = <span class="ruby-constant">ConnectionError</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;connection failed for: #{errors.join(', ')}&quot;</span>)
105:           <span class="ruby-identifier">error</span>.<span class="ruby-identifier">hosts</span> = <span class="ruby-identifier">failed_servers</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-identifier">h</span>[<span class="ruby-identifier">:server</span>] }
106:           <span class="ruby-identifier">raise</span> <span class="ruby-identifier">error</span>
107:         <span class="ruby-keyword kw">end</span>
108:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001472" class="method-detail">
        <a name="M001472"></a>

        <div class="method-heading">
          <a href="#M001472" class="method-signature">
          <span class="method-name">execute_on_servers</span><span class="method-args">(options={}) {|servers_slice| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Determines the set of servers within the current task&#8216;s scope and
establishes connections to them, and then yields that list of servers.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001472-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001472-source">
<pre>
     <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 121</span>
121:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">execute_on_servers</span>(<span class="ruby-identifier">options</span>={})
122:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;expected a block&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">block_given?</span>
123: 
124:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task</span> = <span class="ruby-identifier">current_task</span>
125:           <span class="ruby-identifier">servers</span> = <span class="ruby-identifier">find_servers_for_task</span>(<span class="ruby-identifier">task</span>, <span class="ruby-identifier">options</span>)
126: 
127:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">empty?</span>
128:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">Capistrano</span><span class="ruby-operator">::</span><span class="ruby-constant">NoMatchingServersError</span>, <span class="ruby-node">&quot;`#{task.fully_qualified_name}' is only run for servers matching #{task.options.inspect}, but no servers matched&quot;</span>
129:           <span class="ruby-keyword kw">end</span>
130: 
131:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">continue_on_error?</span>
132:             <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">has_failed?</span>(<span class="ruby-identifier">s</span>) }
133:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">empty?</span>
134:           <span class="ruby-keyword kw">end</span>
135:         <span class="ruby-keyword kw">else</span>
136:           <span class="ruby-identifier">servers</span> = <span class="ruby-identifier">find_servers</span>(<span class="ruby-identifier">options</span>)
137:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">Capistrano</span><span class="ruby-operator">::</span><span class="ruby-constant">NoMatchingServersError</span>, <span class="ruby-node">&quot;no servers found to match #{options.inspect}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">empty?</span>
138:         <span class="ruby-keyword kw">end</span>
139: 
140:         <span class="ruby-identifier">servers</span> = [<span class="ruby-identifier">servers</span>.<span class="ruby-identifier">first</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:once</span>]
141:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">trace</span> <span class="ruby-node">&quot;servers: #{servers.map { |s| s.host }.inspect}&quot;</span>
142: 
143:         <span class="ruby-identifier">max_hosts</span> = (<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:max_hosts</span>] <span class="ruby-operator">||</span> (<span class="ruby-identifier">task</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">max_hosts</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">size</span>).<span class="ruby-identifier">to_i</span>
144:         <span class="ruby-identifier">is_subset</span> = <span class="ruby-identifier">max_hosts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">size</span>
145: 
146:         <span class="ruby-comment cmt"># establish connections to those servers in groups of max_hosts, as necessary</span>
147:         <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">each_slice</span>(<span class="ruby-identifier">max_hosts</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">servers_slice</span><span class="ruby-operator">|</span>
148:           <span class="ruby-keyword kw">begin</span>
149:             <span class="ruby-identifier">establish_connections_to</span>(<span class="ruby-identifier">servers_slice</span>)
150:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ConnectionError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">error</span>
151:             <span class="ruby-identifier">raise</span> <span class="ruby-identifier">error</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">task</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">continue_on_error?</span>
152:             <span class="ruby-identifier">error</span>.<span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span>
153:               <span class="ruby-identifier">servers_slice</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">h</span>)
154:               <span class="ruby-identifier">failed!</span>(<span class="ruby-identifier">h</span>)
155:             <span class="ruby-keyword kw">end</span>
156:           <span class="ruby-keyword kw">end</span>
157: 
158:           <span class="ruby-keyword kw">begin</span>
159:             <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">servers_slice</span>
160:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">RemoteError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">error</span>
161:             <span class="ruby-identifier">raise</span> <span class="ruby-identifier">error</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">task</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">continue_on_error?</span>
162:             <span class="ruby-identifier">error</span>.<span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-identifier">failed!</span>(<span class="ruby-identifier">h</span>) }
163:           <span class="ruby-keyword kw">end</span>
164: 
165:           <span class="ruby-comment cmt"># if dealing with a subset (e.g., :max_hosts is less than the</span>
166:           <span class="ruby-comment cmt"># number of servers available) teardown the subset of connections</span>
167:           <span class="ruby-comment cmt"># that were just made, so that we can make room for the next subset.</span>
168:           <span class="ruby-identifier">teardown_connections_to</span>(<span class="ruby-identifier">servers_slice</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">is_subset</span>
169:         <span class="ruby-keyword kw">end</span>
170:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001479" class="method-detail">
        <a name="M001479"></a>

        <div class="method-heading">
          <a href="#M001479" class="method-signature">
          <span class="method-name">execute_on_servers</span><span class="method-args">(options={}) {|servers_slice| ...}</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Determines the set of servers within the current task&#8216;s scope and
establishes connections to them, and then yields that list of servers.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001479-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001479-source">
<pre>
     <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 121</span>
121:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">execute_on_servers</span>(<span class="ruby-identifier">options</span>={})
122:         <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;expected a block&quot;</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">block_given?</span>
123: 
124:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task</span> = <span class="ruby-identifier">current_task</span>
125:           <span class="ruby-identifier">servers</span> = <span class="ruby-identifier">find_servers_for_task</span>(<span class="ruby-identifier">task</span>, <span class="ruby-identifier">options</span>)
126: 
127:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">empty?</span>
128:             <span class="ruby-identifier">raise</span> <span class="ruby-constant">Capistrano</span><span class="ruby-operator">::</span><span class="ruby-constant">NoMatchingServersError</span>, <span class="ruby-node">&quot;`#{task.fully_qualified_name}' is only run for servers matching #{task.options.inspect}, but no servers matched&quot;</span>
129:           <span class="ruby-keyword kw">end</span>
130: 
131:           <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">continue_on_error?</span>
132:             <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">delete_if</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">has_failed?</span>(<span class="ruby-identifier">s</span>) }
133:             <span class="ruby-keyword kw">return</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">empty?</span>
134:           <span class="ruby-keyword kw">end</span>
135:         <span class="ruby-keyword kw">else</span>
136:           <span class="ruby-identifier">servers</span> = <span class="ruby-identifier">find_servers</span>(<span class="ruby-identifier">options</span>)
137:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">Capistrano</span><span class="ruby-operator">::</span><span class="ruby-constant">NoMatchingServersError</span>, <span class="ruby-node">&quot;no servers found to match #{options.inspect}&quot;</span> <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">empty?</span>
138:         <span class="ruby-keyword kw">end</span>
139: 
140:         <span class="ruby-identifier">servers</span> = [<span class="ruby-identifier">servers</span>.<span class="ruby-identifier">first</span>] <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:once</span>]
141:         <span class="ruby-identifier">logger</span>.<span class="ruby-identifier">trace</span> <span class="ruby-node">&quot;servers: #{servers.map { |s| s.host }.inspect}&quot;</span>
142: 
143:         <span class="ruby-identifier">max_hosts</span> = (<span class="ruby-identifier">options</span>[<span class="ruby-identifier">:max_hosts</span>] <span class="ruby-operator">||</span> (<span class="ruby-identifier">task</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">max_hosts</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">size</span>).<span class="ruby-identifier">to_i</span>
144:         <span class="ruby-identifier">is_subset</span> = <span class="ruby-identifier">max_hosts</span> <span class="ruby-operator">&lt;</span> <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">size</span>
145: 
146:         <span class="ruby-comment cmt"># establish connections to those servers in groups of max_hosts, as necessary</span>
147:         <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">each_slice</span>(<span class="ruby-identifier">max_hosts</span>) <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">servers_slice</span><span class="ruby-operator">|</span>
148:           <span class="ruby-keyword kw">begin</span>
149:             <span class="ruby-identifier">establish_connections_to</span>(<span class="ruby-identifier">servers_slice</span>)
150:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">ConnectionError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">error</span>
151:             <span class="ruby-identifier">raise</span> <span class="ruby-identifier">error</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">task</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">continue_on_error?</span>
152:             <span class="ruby-identifier">error</span>.<span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span>
153:               <span class="ruby-identifier">servers_slice</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">h</span>)
154:               <span class="ruby-identifier">failed!</span>(<span class="ruby-identifier">h</span>)
155:             <span class="ruby-keyword kw">end</span>
156:           <span class="ruby-keyword kw">end</span>
157: 
158:           <span class="ruby-keyword kw">begin</span>
159:             <span class="ruby-keyword kw">yield</span> <span class="ruby-identifier">servers_slice</span>
160:           <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">RemoteError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">error</span>
161:             <span class="ruby-identifier">raise</span> <span class="ruby-identifier">error</span> <span class="ruby-keyword kw">unless</span> <span class="ruby-identifier">task</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">task</span>.<span class="ruby-identifier">continue_on_error?</span>
162:             <span class="ruby-identifier">error</span>.<span class="ruby-identifier">hosts</span>.<span class="ruby-identifier">each</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">h</span><span class="ruby-operator">|</span> <span class="ruby-identifier">failed!</span>(<span class="ruby-identifier">h</span>) }
163:           <span class="ruby-keyword kw">end</span>
164: 
165:           <span class="ruby-comment cmt"># if dealing with a subset (e.g., :max_hosts is less than the</span>
166:           <span class="ruby-comment cmt"># number of servers available) teardown the subset of connections</span>
167:           <span class="ruby-comment cmt"># that were just made, so that we can make room for the next subset.</span>
168:           <span class="ruby-identifier">teardown_connections_to</span>(<span class="ruby-identifier">servers_slice</span>) <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">is_subset</span>
169:         <span class="ruby-keyword kw">end</span>
170:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001473" class="method-detail">
        <a name="M001473"></a>

        <div class="method-heading">
          <a href="#M001473" class="method-signature">
          <span class="method-name">failed!</span><span class="method-args">(server)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Indicate that the given server could not be connected to.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001473-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001473-source">
<pre>
    <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 58</span>
58:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">failed!</span>(<span class="ruby-identifier">server</span>)
59:         <span class="ruby-ivar">@failed_sessions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">server</span>
60:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001466" class="method-detail">
        <a name="M001466"></a>

        <div class="method-heading">
          <a href="#M001466" class="method-signature">
          <span class="method-name">failed!</span><span class="method-args">(server)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Indicate that the given server could not be connected to.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001466-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001466-source">
<pre>
    <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 58</span>
58:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">failed!</span>(<span class="ruby-identifier">server</span>)
59:         <span class="ruby-ivar">@failed_sessions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">server</span>
60:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001467" class="method-detail">
        <a name="M001467"></a>

        <div class="method-heading">
          <a href="#M001467" class="method-signature">
          <span class="method-name">has_failed?</span><span class="method-args">(server)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Query whether previous connection attempts to the given server have failed.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001467-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001467-source">
<pre>
    <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 64</span>
64:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_failed?</span>(<span class="ruby-identifier">server</span>)
65:         <span class="ruby-ivar">@failed_sessions</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">server</span>)
66:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001474" class="method-detail">
        <a name="M001474"></a>

        <div class="method-heading">
          <a href="#M001474" class="method-signature">
          <span class="method-name">has_failed?</span><span class="method-args">(server)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Query whether previous connection attempts to the given server have failed.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001474-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001474-source">
<pre>
    <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 64</span>
64:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">has_failed?</span>(<span class="ruby-identifier">server</span>)
65:         <span class="ruby-ivar">@failed_sessions</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">server</span>)
66:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001478" class="method-detail">
        <a name="M001478"></a>

        <div class="method-heading">
          <a href="#M001478" class="method-signature">
          <span class="method-name">teardown_connections_to</span><span class="method-args">(servers)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Destroys sessions for each server in the list.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001478-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001478-source">
<pre>
     <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 111</span>
111:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">teardown_connections_to</span>(<span class="ruby-identifier">servers</span>)
112:         <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span><span class="ruby-operator">|</span>
113:            <span class="ruby-ivar">@sessions</span>[<span class="ruby-identifier">server</span>].<span class="ruby-identifier">close</span>
114:            <span class="ruby-ivar">@sessions</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">server</span>)
115:          <span class="ruby-keyword kw">end</span>
116:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M001471" class="method-detail">
        <a name="M001471"></a>

        <div class="method-heading">
          <a href="#M001471" class="method-signature">
          <span class="method-name">teardown_connections_to</span><span class="method-args">(servers)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Destroys sessions for each server in the list.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M001471-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M001471-source">
<pre>
     <span class="ruby-comment cmt"># File lib/capistrano/configuration/connections.rb, line 111</span>
111:       <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">teardown_connections_to</span>(<span class="ruby-identifier">servers</span>)
112:         <span class="ruby-identifier">servers</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword kw">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">server</span><span class="ruby-operator">|</span>
113:            <span class="ruby-ivar">@sessions</span>[<span class="ruby-identifier">server</span>].<span class="ruby-identifier">close</span>
114:            <span class="ruby-ivar">@sessions</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-identifier">server</span>)
115:          <span class="ruby-keyword kw">end</span>
116:       <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>